# if(kakao) dev 2019 Day1



# 오픈소스 데이터베이스, 흐르는 은행 데이터에 빨대를 꽂아보다.

##### 성동찬(chan) / 카카오뱅크

금융권에서는 mysql을 쓴다는 것 자체를 받아들여하기 어려웠음. but 2년 동안 장애없이 잘 운영중ㅎㅎ

금융의 탈을 쓴 소셜 서비스

## 데이터를 분산 재배치하기

* SQL로
  * 장점 : SQL로 자유롭게 제어, 로직에 포함되며, 상대적으로 구조가 간결
  * 단점 : 소스 DB에 부하, **지연된 커밋에 따라 데이터 누락 발생 가능 => 은..은행인데? 돈.. 날아..가...ㅎㄷㄷ 넘나 위험...**
* CDC로
  * 장점 : 소스디비에 부하가 거의 없음. 누락없이 실시간 전송 보장
  * 단점 : 비동기 데이터 복제 및 복제 시스템 운영, **분산로직 적용이 어려움 => 엌..? 분산 재배치해야하는데..?? 손..손..으로???**
* 손으로 노가다... => 시무룩..

## Uldra

카카오뱅크에서 임의적으로 만든 시스템

실시간으로 생성되는 바이너리 로우 데이터를 훑어서 효과적으로 백업 및 복구 프로세스를 구축한 것

### 개발 이유

1. 

2. 

3. 

### My SQL Binary Log

트랜잭션 커밋 시 파일로 기록되는 로그파일,  데이터 변경 순서를 보장한다.

**신뢰할 수 있는 확정된 이력**

### History

* 2015 kakao sharding rebalancer
* 2016 [kakao adt](https://github.com/kakao/adt)

* 2019 ULDRAMAN

## ULDRA + ADT 가 함께 공유하는 가치

### Ovewrite

덮어쓰다보면 언젠가는 복구된다

* WRITE ROW EVENTS -> REPLACE INTO
* DELETE ROW EVENTS-> DELETE FROM
* UPDATE -> DELETE, REPLACE
  * 샤드키 혹은 PK 변경? => YES :  DELETE / NO : REPLACE

### Sequential

데이터를 그룹핑하고 동일 그룹 데이터는 순차처리한다

데이터를 분류하여 순차처리

### Parallel

데이터를 그룹핑하고 성능을 극대화한다

연관없는 데이터는 병렬처리

## ULDRA 만의 피쳐

### dd

### Generate Shard Value

샤드 값을 기준으로 분류함 /(샤딩)

### Mapping Trigger

타겟 데이터를 마음대로 바꿔보고 싶어요 (최종적으로 타겟데이터를 변경하기 위해서)

기존 데이터를 조합해서 새로운 데이터구조로 변경하고 싶은 경우

### Interface

하드코딩 노노! 개발자들이 사용할 수 있도록 인터페이스화 시켜둠

## 퍼포먼스 체크하기

으아 앞부분 놓치....ㅠㅠㅠㅠ



# 초당옥수수의 취소를 막아라! : 수만 건의 주문을 1초내에 처리하는 기술

##### 고희경(sally.vic), 마태일(dwayne.m) / 카카오커머스

액터모델 사용했군

TMS(타겟 메세지 전송)

## Legacy 시스템의 문제

### 배송 지연 안내 TMS 배치 문제

실시간 처리가 아닌 1시간 단위의 배치 처리였음...

5분으로 줄여볼 수도 있었지만 근본적인 해결이 아님..

### 복잡한 비즈니스 로직 

이로 인해 배치를 실시간으로 바꾸기 어려웠음

### 처리속도 

단일 스테드에서 태스크 수행 => 느리다

Fork, thread 등의 병렬처리를 고려해볼 수 있었지만 위험성때문에 XXX

## Mission

### 실시간 TMS 발송을 위한 워커 구성

동기적으로 발송하고 있었기 때문에 주문완료 후 돌리기 너무 무거웠음

비동기 워커로 TMS 시스템을 구성함

### 복잡한 비즈니스 코드 리팩토링

### 처리속도 개선

## 액터가 된 비동기 워커

### 분산처리

쉽게 분산처리 할 수 있는 구조

비즈니스 종류에 따라 설정할 수 있는 컨피그 파일 구조

### 자동 재처리 및 실패 감지

커슈머 처리시 예외 발생

### 구현 ([RabbitMQ](https://www.rabbitmq.com/))

Message Header 와 Queue 속성을 활용해 재처리/실패 전략 수립

Consumer 생성 시 커스텀 메서드 인터셉터를 Advice Chain으로 셋팅

### 액터 모델

액터모델의 강점인 Scalable 에 집중했다.

다른 많은 더 좋은 액터모델 프레임웤이나 라이브러리가 존재하지만 현재 서비스에 적합한 경량버전으로 개발함

## 배포없이 빠르게 롤백하는 전략

On/Off 스위치를 구현하여 빌드시 스위치를 on/off 하는 식으로 진행함 (앱에서 리모트 컨피그 마냥)



# 카카오뱅크 모바일앱의 DevOps

## 개요

사진첨부

## 상세

###스케쥴링

매주 월요일 업무 시작 알림 (스프린트봇)

주 단위 스프린트

### 개발

* 효율적인 개발
  * 도구 : 오픈소스 권장 (안드 24개, ios 18개)
    * 검증되었는지?
    * 동료 모두와 합의되었는지? 
* 안정적인 개발
  * 문화 : 페어 프로그래밍
  * 도구 : 공동 개발 문서화 (Android 와 ios 함께 문서 작성)
    * 개발 전 이해도 맞추기
    * 히스토리 축적
    * 비즈니스 로직 동기화
    * 크로스 체크
* 개발 진행 상황 공유
  * 문화 : 일일 스크럼 회의 (하루에 다 같이 만나는 단 10분의 시간)

### 코드리뷰

* 코드리뷰를 하기 위한 준비
  * 도구 : 코드리뷰 사전 자동화 (빌드까지 다 끝나야 코드리뷰를 받을 수 있도록 셋팅)
* 코드리뷰 알림
  * 도구 : 코드리뷰 도우미
    * 카뱅은 GitLab을 씀. Chrome Extension 코드 리뷰 도우미 자체개발.
* 코드리뷰 시작
  * 문화 : 코드리뷰 규칙
    * 코드 리뷰어 자동 할당 (1명은 직접 리뷰어 지정 / 3명 랜덤 자동 할당)
    * 3명 이상의 좋아요를 받아야 코드 머지 가능
  * 문화 : 온라인 코드리뷰
  * 문화 : 오프라인 코드리뷰
    * 규모가 크거나 중요한 코드는 따로 만나서 회의

### 빌드/배포

* 책임자만 코드 머지 가능
  * 문화 : 코드 머지 규칙
    * 최종 코드 머지는 책임자에 의해서만 (안드 1명, ios 1명)
* 테스트앱 빌드 & 배포
  * 도구 : 빌드/배포 자동화
* ㅇㅇ
  * 문화 : 병렬 배포
    * 1일 다양한 피처들을 다수 배포

### 테스트

개발조직과 QA조직이 따로 분리되어 있지 않음 => 앱에 대한 품질을 오직 QA만이 보장하는 것이 아니기 때문.

* QA에서 테스트앱 테스트
  * 문화 : QA + 개발 조직 (대립관계가 아니라 협력 관계다)
* 다양한 단계로 QA 테스트
  * Sanity 테스트 : 새롭게 추가된 기능에 한해서 다같이 모여 테스트 (기획+개발+디자인 등등 모두 다)
    * 통합테스트에 들어가기 앞서 QA 조직의 리소스를 절약
  * 문화 : 통합/운영 테스트
    * Sanity 테스트 : 1~3회
    * 통합 테스트 : 3~6주
    * 운영 테스트 : 1~2주
    * 시나리오 테스트 : 주1회 혹은 상시 (오류를 찾는 마지막 방어선)

### 릴리즈

* 스토어를 통해 앱 릴리즈
  * 문화 : 단계적 출시
* 출시 후 모니터링
  * 도구 : 앱스토어 리뷰 봇
    * 매일 리뷰 내용을 알림해줌
    * 부정적 키워드 혹은 특정 키워드에 대한 알림

### 운영

* 릴리즈에 대한 회고
  * 문화 : 회고 (지난 릴리즈에 대한 칭찬과 반성 / 앞으로 개선해야 할 액션 플랜 함께 정하기)
    * 개발 운영(리뷰봇 등)에 관련된 아이디어들이 회고에서 굉장히 많이 나옴! 개굿!
  * 문화 : 주간 온도 (한 주 간의 동료들의 기분 온도계)
* 기술 역량 향상
  * 문화 : 기술 세미나 (업무의 10%는 자기계발에 투자)
  * 문화 : 개발잡담 (새롭게 적용하는 것에 대한 협의, 가볍게 얘기 나누면 좋을 법한 이야기들)
* 다음 릴리즈 스케쥴링 시작



# 돈이 오고가는 금융프로젝트인 펌 뱅킹 서비스에서의 코틀린 적용 사례

###### 강현식(kaka.wesome) / 카카오페이

 